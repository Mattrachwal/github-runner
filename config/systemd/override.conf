[Service]
User=github-runner
Group=github-runner

# Set per-instance HOME - this overrides systemd's default
Environment=HOME=/var/lib/github-runner/%i
Environment=USER=github-runner
Environment=LOGNAME=github-runner

# CRITICAL: Actions tool cache and temp directories
# These are required for setup-* actions (node, python, etc.) to work properly
Environment=RUNNER_TOOL_CACHE=/opt/actions/_tool
Environment=RUNNER_TEMP=/var/lib/github-runner/%i/_temp
Environment=AGENT_TOOLSDIRECTORY=/opt/actions/_tool

# Set working directory to the runner installation
WorkingDirectory=/opt/actions-runner/%i

# Prevent git config conflicts
Environment=GIT_CONFIG_GLOBAL=/dev/null
Environment=GIT_CONFIG_SYSTEM=/dev/null

# CRITICAL: Clear the base ExecStart and replace without -l flag
# The -l flag causes login shell behavior which can override our environment
ExecStart=
ExecStart=/bin/bash -c 'cd /opt/actions-runner/%i && exec ./run.sh --startuptype service'

# Timeouts to prevent hanging
TimeoutStartSec=300
TimeoutStopSec=60

# Optional: Resource limits (uncomment if needed)
# MemoryMax=4G
# CPUQuota=80%
# TasksMax=1000